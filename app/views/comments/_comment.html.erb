<div class="card <%= 'ml-12' if depth > 0 %>" data-controller="comment" data-comment-id="<%= comment.id %>">
  <div class="flex items-start gap-3">
    <div class="w-10 h-10 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-bold flex-shrink-0">
      <%= comment.user.display_name[0].upcase %>
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-center justify-between mb-2">
        <%= link_to comment.user.display_name, user_path(comment.user), class: "font-bold text-foreground hover:text-primary" %>
        <span class="text-sm text-muted-foreground"><%= time_ago_in_words(comment.created_at) %> ago</span>
      </div>
      <p class="text-foreground whitespace-pre-wrap mb-2"><%= comment.content %></p>

      <!-- Image du commentaire -->
      <% if comment.image.attached? %>
        <div class="mt-3 mb-2">
          <%= image_tag comment.image.variant(resize_to_limit: [500, 400]), class: "rounded-lg border border-border max-w-full" %>
        </div>
      <% end %>

      <!-- Actions du commentaire -->
      <div class="flex items-center gap-4 text-sm">
        <button type="button"
                data-action="click->comment#toggleReplyForm"
                class="text-muted-foreground hover:text-primary transition-colors">
          Répondre
        </button>
        <% if comment.replies.any? %>
          <span class="text-muted-foreground">
            <%= comment.replies.count %> <%= comment.replies.count == 1 ? 'réponse' : 'réponses' %>
          </span>
        <% end %>
      </div>

      <!-- Formulaire de réponse (caché par défaut) -->
      <div data-comment-target="replyForm" class="hidden mt-4">
        <%= form_with(model: [post, Comment.new], url: post_comments_path(post), class: "space-y-3") do |form| %>
          <%= form.hidden_field :parent_id, value: comment.id %>
          <%= form.text_area :content,
            rows: 2,
            class: "input w-full text-sm",
            placeholder: "Répondre à #{comment.user.display_name}...",
            required: true %>
          <div class="flex items-center gap-3">
            <%= form.file_field :image,
              accept: 'image/*',
              class: "text-sm text-muted-foreground file:mr-4 file:py-1.5 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-primary file:text-primary-foreground hover:file:bg-primary/90 file:cursor-pointer" %>
          </div>
          <div class="flex gap-2">
            <%= form.submit "Répondre", class: "btn-primary text-sm py-1.5 px-4" %>
            <button type="button"
                    data-action="click->comment#toggleReplyForm"
                    class="btn-secondary text-sm py-1.5 px-4">
              Annuler
            </button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Réponses au commentaire -->
  <% if comment.replies.any? %>
    <div class="mt-4 space-y-4">
      <% comment.replies.order(created_at: :asc).each do |reply| %>
        <%= render 'comments/comment', comment: reply, post: post, depth: depth + 1 %>
      <% end %>
    </div>
  <% end %>
</div>
