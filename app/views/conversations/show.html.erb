<% content_for :page_title, "Conversation avec #{@recipient.display_name}" %>

<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4 sm:mb-6 animate-fade-in-up gap-2">
    <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
      <%= link_to conversations_path, class: "text-muted-foreground hover:text-primary p-1 sm:p-2 flex-shrink-0" do %>
        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      <% end %>
      <div class="w-10 h-10 sm:w-12 sm:h-12 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-bold text-base sm:text-lg flex-shrink-0">
        <%= @recipient.display_name[0].upcase %>
      </div>
      <div class="min-w-0 flex-1">
        <h1 class="text-base sm:text-xl font-bold text-foreground truncate"><%= @recipient.display_name %></h1>
        <p class="text-xs sm:text-sm text-muted-foreground">@<%= @recipient.username %></p>
      </div>
    </div>
    <%= link_to user_path(@recipient), class: "btn-secondary text-xs sm:text-sm px-2 sm:px-4 py-1.5 sm:py-2 flex-shrink-0" do %>
      <span class="hidden sm:inline">Voir le profil</span>
      <svg class="w-4 h-4 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
    <% end %>
  </div>

  <!-- Messages -->
  <div class="card mb-4 sm:mb-6 animate-fade-in-up" style="animation-delay: 100ms;">
    <div id="messages_container" class="space-y-3 sm:space-y-4 max-h-[60vh] sm:max-h-[500px] overflow-y-auto mb-4 sm:mb-6 p-3 sm:p-4 bg-secondary/20 rounded">
      <div id="messages_list" class="space-y-3 sm:space-y-4">
        <% if @messages.any? %>
          <% @messages.each do |message| %>
            <div class="flex <%= message.sender == current_user ? 'justify-end' : 'justify-start' %>">
              <div class="max-w-[85%] sm:max-w-[70%] <%= message.sender == current_user ? 'text-primary-foreground border border-border' : 'bg-card border border-border' %> rounded-lg p-2 sm:p-3" style="<%= message.sender == current_user ? 'background-color: var(--accent)' : '' %>">
                <p class="text-xs sm:text-sm whitespace-pre-wrap"><%= message.content %></p>
                <div class="flex items-center gap-1 sm:gap-2 mt-1 text-xs opacity-70">
                  <span><%= message.created_at.strftime('%H:%M') %></span>
                  <% if message.sender == current_user && message.read? %>
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-6 sm:py-8">
            <p class="text-sm sm:text-base text-muted-foreground">Début de votre conversation avec <%= @recipient.display_name %></p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Formulaire de nouveau message -->
    <%= render partial: "form", locals: { recipient: @recipient } %>
  </div>
</div>

<script>
  // Auto-scroll vers le bas des messages au chargement initial
  function scrollToBottom() {
    const messagesContainer = document.getElementById('messages_container');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  // Scroll au chargement de la page
  document.addEventListener('DOMContentLoaded', scrollToBottom);

  // Scroll après navigation Turbo
  document.addEventListener('turbo:load', scrollToBottom);

  // Scroll après l'ajout d'un nouveau message via Turbo Stream
  document.addEventListener('turbo:before-stream-render', function(event) {
    // Scroll uniquement si c'est un message ajouté à la liste
    if (event.target.getAttribute('target') === 'messages_list') {
      setTimeout(scrollToBottom, 50);
    }
  });
</script>
