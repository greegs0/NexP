<% content_for :page_title, "Fil d'actualité" %>

<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="mb-4 sm:mb-6 animate-fade-in-up">
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-foreground tracking-tight mb-1 sm:mb-2">
      Fil d'actualité<span class="text-primary">.</span>
    </h1>
    <p class="text-sm sm:text-base text-muted-foreground">Découvre ce qui se passe dans ta communauté</p>
  </div>

  <!-- Filtres - Compact Pills -->
  <div class="mb-4 sm:mb-6 animate-fade-in-up relative z-20" style="animation-delay: 50ms;">
    <div class="flex items-center gap-1 p-1 bg-secondary/50 rounded-xl overflow-x-auto scrollbar-hide">
      <%= link_to "Tous", feed_path, class: "filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all #{@active_filter.blank? ? 'active' : ''}" %>
      <%= link_to "Images", feed_path(filter: 'images'), class: "filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all #{@active_filter == 'images' ? 'active' : ''}" %>
      <%= link_to "Populaires", feed_path(filter: 'popular'), class: "filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all #{@active_filter == 'popular' ? 'active' : ''}" %>
      <%= link_to "Commentés", feed_path(filter: 'commented'), class: "filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all #{@active_filter == 'commented' ? 'active' : ''}" %>
      <%= link_to "Mes posts", feed_path(filter: 'mine'), class: "filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all #{@active_filter == 'mine' ? 'active' : ''}" %>

      <% if @filter_skills.any? %>
        <div class="relative" data-controller="dropdown">
          <button data-action="click->dropdown#toggle" class="filter-pill px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-lg whitespace-nowrap transition-all inline-flex items-center gap-1 <%= @active_filter == 'skill' ? 'active' : '' %>">
            <%= @active_filter == 'skill' && @active_skill.present? ? Skill.find_by(id: @active_skill)&.name || 'Compétence' : 'Compétence' %>
            <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div data-dropdown-target="menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-card border border-border rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto py-1 right-0 sm:right-auto sm:left-0">
            <% @filter_skills.each do |skill| %>
              <%= link_to skill.name, feed_path(filter: 'skill', skill_id: skill.id), class: "block px-4 py-2 text-sm hover:bg-secondary/50 transition-colors #{'text-primary font-medium' if @active_skill.to_s == skill.id.to_s}" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
    <!-- Colonne principale : Feed -->
    <div class="lg:col-span-2 order-2 lg:order-1">
      <!-- Créer un post -->
      <div class="card mb-4 sm:mb-6 animate-fade-in-up" style="animation-delay: 100ms;">
        <%= link_to new_post_path, class: "flex items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-secondary/20 rounded hover:bg-secondary/30 transition-colors" do %>
          <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-bold text-sm sm:text-base">
            <%= current_user.display_name[0].upcase %>
          </div>
          <span class="text-sm sm:text-base text-muted-foreground flex-1">Quoi de neuf <%= current_user.display_name.split.first %> ?</span>
          <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        <% end %>
      </div>

      <!-- Posts du feed -->
      <% if @posts.any? %>
        <div class="space-y-4 sm:space-y-6">
          <% @posts.each_with_index do |post, index| %>
            <div class="card animate-fade-in-up" style="animation-delay: <%= 150 + (index * 50) %>ms;">
              <!-- Header du post -->
              <div class="flex items-start justify-between mb-3 sm:mb-4">
                <div class="flex items-center gap-2 sm:gap-3">
                  <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-bold text-sm sm:text-base">
                    <%= post.user.display_name[0].upcase %>
                  </div>
                  <div>
                    <%= link_to post.user.display_name, user_path(post.user), class: "font-bold text-sm sm:text-base text-foreground hover:text-primary" %>
                    <div class="text-xs sm:text-sm text-muted-foreground">
                      <%= time_ago_in_words(post.created_at) %> ago
                    </div>
                  </div>
                </div>
              </div>

              <!-- Contenu -->
              <div class="mb-3 sm:mb-4">
                <p class="text-foreground whitespace-pre-wrap"><%= truncate(post.content, length: 300) %></p>
                <% if post.content.length > 300 %>
                  <%= link_to "Lire la suite", post_path(post), class: "text-primary hover:text-primary/80 text-sm font-medium" %>
                <% end %>
                <% if post.image.attached? %>
                  <div class="mt-3">
                    <%= link_to post_path(post) do %>
                      <%= image_tag post.image.variant(resize_to_limit: [600, 400]), class: "rounded-lg border border-border w-full hover:opacity-90 transition-opacity" %>
                    <% end %>
                  </div>
                <% end %>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-4 sm:gap-6 text-muted-foreground border-t border-border pt-3 sm:pt-4">
                <%= render 'posts/like_button', post: post, size: 5, show_count_label: false %>

                <%= link_to post_path(post), class: "inline-flex items-center gap-2 hover:text-primary transition-colors group" do %>
                  <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <span class="text-sm font-medium"><%= post.comments_count %></span>
                <% end %>

                <div class="ml-auto">
                  <%= render "bookmarks/bookmark_button", bookmarkable: post, style: :icon %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
          <%= paginate @posts %>
        </div>
      <% else %>
        <div class="card text-center py-8 sm:py-16">
          <svg class="w-12 h-12 sm:w-16 sm:h-16 text-muted-foreground mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <p class="text-sm sm:text-base text-muted-foreground mb-4 sm:mb-6">Ton feed est vide. Commence par suivre des développeurs!</p>
          <%= link_to users_path, class: "btn-primary inline-flex items-center gap-2" do %>
            Trouver des développeurs
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Colonne latérale : Suggestions et projets -->
    <div class="lg:col-span-1 space-y-4 sm:space-y-6 order-1 lg:order-2">
      <!-- Suggestions d'utilisateurs -->
      <div class="card animate-fade-in-up" style="animation-delay: 100ms;">
        <h3 class="font-bold text-sm sm:text-base text-foreground mb-3 sm:mb-4">Suggestions pour toi</h3>
        <% if @suggested_users.any? %>
          <div class="flex lg:flex-col gap-3 sm:gap-4 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 scrollbar-hide">
            <% @suggested_users.each do |user| %>
              <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0 lg:flex-shrink">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">
                  <%= user.display_name[0].upcase %>
                </div>
                <div class="flex-1 min-w-0">
                  <%= link_to user.display_name, user_path(user), class: "font-bold text-xs sm:text-sm text-foreground hover:text-primary block truncate" %>
                  <p class="text-xs text-muted-foreground truncate hidden lg:block"><%= user.skills.limit(2).pluck(:name).join(', ') %></p>
                </div>
                <%= button_to follow_user_path(user), method: :post, class: "btn-primary text-xs px-2 sm:px-3 py-1" do %>
                  Suivre
                <% end %>
              </div>
            <% end %>
          </div>
          <%= link_to users_path, class: "text-primary hover:text-primary/80 text-xs sm:text-sm font-medium block mt-3 sm:mt-4 hidden lg:block" do %>
            Voir plus →
          <% end %>
        <% else %>
          <p class="text-sm text-muted-foreground mb-3">Ajoute des compétences à ton profil pour voir des suggestions.</p>
          <%= link_to users_path, class: "btn-secondary text-xs inline-flex items-center gap-2" do %>
            Explorer les développeurs
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          <% end %>
        <% end %>
      </div>

      <!-- Projets récents - Hidden on mobile, visible on lg screens -->
      <div class="card animate-fade-in-up hidden lg:block" style="animation-delay: 200ms;">
        <h3 class="font-bold text-foreground mb-4">Projets récents</h3>
        <% if @recent_projects.any? %>
          <div class="space-y-4">
            <% @recent_projects.each do |project| %>
              <%= link_to project_path(project), class: "block group" do %>
                <h4 class="font-bold text-sm text-foreground group-hover:text-primary mb-1"><%= truncate(project.title, length: 40) %></h4>
                <p class="text-xs text-muted-foreground mb-2">Par <%= project.owner.display_name %></p>
                <% if project.skills.any? %>
                  <div class="flex flex-wrap gap-1">
                    <% project.skills.limit(3).each do |skill| %>
                      <span class="text-xs px-2 py-0.5 bg-secondary text-secondary-foreground rounded">
                        <%= skill.name %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            <% end %>
          </div>
          <%= link_to projects_path, class: "text-primary hover:text-primary/80 text-sm font-medium block mt-4" do %>
            Voir tous les projets →
          <% end %>
        <% else %>
          <p class="text-sm text-muted-foreground mb-3">Aucun projet pour le moment.</p>
          <%= link_to new_project_path, class: "btn-primary text-xs inline-flex items-center gap-2" do %>
            Créer un projet
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
